{% extends "base.html" %}

{% block title %}Settings - Best Friend AI Companion{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Settings</h1>
        <p class="text-gray-600 dark:text-gray-400">Configure your AI companion</p>
    </div>
    
    <form method="POST" class="space-y-8">
        {{ csrf_token() }}
        <!-- Profile Settings -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Profile Settings</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Name</label>
                    <input type="text" id="name" name="name" value="{{ settings.get('name', '') }}"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>
                
                <div>
                    <label for="timezone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Timezone</label>
                    <select id="timezone" name="timezone" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <option value="UTC" {% if settings.get('timezone') == 'UTC' %}selected{% endif %}>UTC</option>
                        <option value="America/New_York" {% if settings.get('timezone') == 'America/New_York' %}selected{% endif %}>Eastern Time</option>
                        <option value="America/Chicago" {% if settings.get('timezone') == 'America/Chicago' %}selected{% endif %}>Central Time</option>
                        <option value="America/Denver" {% if settings.get('timezone') == 'America/Denver' %}selected{% endif %}>Mountain Time</option>
                        <option value="America/Los_Angeles" {% if settings.get('timezone') == 'America/Los_Angeles' %}selected{% endif %}>Pacific Time</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label for="bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bio</label>
                    <textarea id="bio" name="bio" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                              placeholder="Tell me about yourself...">{{ settings.get('bio', '') }}</textarea>
                </div>
            </div>
        </div>
        
        <!-- AI Configuration -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">AI Configuration</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="ollama_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Remote Ollama Server URL</label>
                    <input type="url" id="ollama_url" name="ollama_url" 
                           value="{{ settings.get('ollama_url', 'http://your-ollama-server:11434') }}"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                           placeholder="http://your-ollama-server:11434">
                    <p class="text-sm text-gray-500 mt-1">Enter the URL of your remote Ollama server</p>
                </div>
                
                <div>
                    <label for="ollama_model" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">AI Model</label>
                    <input type="text" id="ollama_model" name="ollama_model" 
                           value="{{ settings.get('ollama_model', 'llama3.1:8b') }}"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                           placeholder="llama3.1:8b">
                </div>
                
                <div>
                    <label for="temperature" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Temperature</label>
                    <input type="range" id="temperature" name="temperature" min="0.0" max="2.0" step="0.1" 
                           value="{{ settings.get('temperature', '0.7') }}"
                           class="w-full">
                    <span id="temperature_value" class="text-sm text-gray-500">{{ settings.get('temperature', '0.7') }}</span>
                </div>
                
                <div>
                    <label for="top_p" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Top-P</label>
                    <input type="range" id="top_p" name="top_p" min="0.1" max="1.0" step="0.1" 
                           value="{{ settings.get('top_p', '0.9') }}"
                           class="w-full">
                    <span id="top_p_value" class="text-sm text-gray-500">{{ settings.get('top_p', '0.9') }}</span>
                </div>
                
                <div class="md:col-span-2">
                    <label for="personality" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">AI Personality</label>
                    <textarea id="personality" name="personality" rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                              placeholder="Describe how you want your AI companion to behave...">{{ settings.get('personality', 'You are a helpful and friendly AI companion. You are knowledgeable, empathetic, and always ready to help with conversation, advice, or just being a good friend.') }}</textarea>
                </div>
            </div>
        </div>
        
        <!-- Voice Settings -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Voice Settings</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="tts_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">TTS Server URL</label>
                    <input type="url" id="tts_url" name="tts_url" 
                           value="{{ settings.get('tts_url', 'http://opentts:5500') }}"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                           placeholder="http://opentts:5500">
                </div>
                
                <div>
                    <label for="tts_voice" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Voice</label>
                    <input type="text" id="tts_voice" name="tts_voice" 
                           value="{{ settings.get('tts_voice', 'en_US-amy-low') }}"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                           placeholder="en_US-amy-low">
                </div>
                
                <div>
                    <label for="speaking_rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Speaking Rate</label>
                    <input type="range" id="speaking_rate" name="speaking_rate" min="0.5" max="2.0" step="0.1" 
                           value="{{ settings.get('speaking_rate', '1.0') }}"
                           class="w-full">
                    <span id="speaking_rate_value" class="text-sm text-gray-500">{{ settings.get('speaking_rate', '1.0') }}</span>
                </div>
                
                <div>
                    <label for="pitch" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pitch</label>
                    <input type="range" id="pitch" name="pitch" min="0.5" max="2.0" step="0.1" 
                           value="{{ settings.get('pitch', '1.0') }}"
                           class="w-full">
                    <span id="pitch_value" class="text-sm text-gray-500">{{ settings.get('pitch', '1.0') }}</span>
                </div>
            </div>
        </div>
        
        <!-- Memory Settings -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Memory & Privacy</h2>
            
            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="checkbox" id="memory_enabled" name="memory_enabled" value="true" 
                           {% if settings.get('memory_enabled', 'true') == 'true' %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="memory_enabled" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Enable long-term memory
                    </label>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="auto_summarize" name="auto_summarize" value="true" 
                           {% if settings.get('auto_summarize', 'true') == 'true' %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="auto_summarize" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Auto-summarize conversations
                    </label>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="share_analytics" name="share_analytics" value="true" 
                           {% if settings.get('share_analytics', 'false') == 'true' %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="share_analytics" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Share usage analytics (anonymous)
                    </label>
                </div>
            </div>
            
            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Data Management</h3>
                
                <div class="flex space-x-4">
                    <a href="{{ url_for('privacy.export_data') }}" 
                       class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Export My Data
                    </a>
                    
                    <button type="button" id="deleteDataBtn"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Delete All Data
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="flex justify-end">
            <button type="submit" 
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                Save Settings
            </button>
        </div>
    </form>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Delete All Data?</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
                This action cannot be undone. All your conversations, memories, and settings will be permanently deleted.
            </p>
            <div class="flex space-x-4 justify-center">
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Yes, Delete Everything
                </button>
                <button id="cancelDelete" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update range input values
    const speakingRate = document.getElementById('speaking_rate');
    const speakingRateValue = document.getElementById('speaking_rate_value');
    const pitch = document.getElementById('pitch');
    const pitchValue = document.getElementById('pitch_value');
    const temperature = document.getElementById('temperature');
    const temperatureValue = document.getElementById('temperature_value');
    const topP = document.getElementById('top_p');
    const topPValue = document.getElementById('top_p_value');
    
    speakingRate.addEventListener('input', function() {
        speakingRateValue.textContent = this.value;
    });
    
    pitch.addEventListener('input', function() {
        pitchValue.textContent = this.value;
    });
    
    temperature.addEventListener('input', function() {
        temperatureValue.textContent = this.value;
    });
    
    topP.addEventListener('input', function() {
        topPValue.textContent = this.value;
    });
    
    // Delete data modal
    const deleteDataBtn = document.getElementById('deleteDataBtn');
    const deleteModal = document.getElementById('deleteModal');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');
    
    deleteDataBtn.addEventListener('click', function() {
        deleteModal.classList.remove('hidden');
        deleteModal.classList.add('flex');
    });
    
    cancelDelete.addEventListener('click', function() {
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
    });
    
    confirmDelete.addEventListener('click', async function() {
        try {
            const response = await fetch('/api/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                window.location.href = '/auth/login';
            } else {
                alert('Failed to delete data. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting data.');
        }
        
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
    });
});
</script>
{% endblock %}
