{% extends "base.html" %}

{% block title %}Settings - Best Friend AI Companion{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Settings</h1>
        <p class="text-gray-600 dark:text-gray-400">Configure your AI companion</p>
    </div>
    
    <form method="POST" class="space-y-8">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <!-- Profile Settings -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Profile Settings</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Name</label>
                    <input type="text" id="name" name="name" value="{{ settings.get('name', '') }}"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>
                
                <div>
                    <label for="timezone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Timezone</label>
                    <select id="timezone" name="timezone" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <option value="UTC" {% if settings.get('timezone') == 'UTC' %}selected{% endif %}>UTC</option>
                        <option value="America/New_York" {% if settings.get('timezone') == 'America/New_York' %}selected{% endif %}>Eastern Time</option>
                        <option value="America/Chicago" {% if settings.get('timezone') == 'America/Chicago' %}selected{% endif %}>Central Time</option>
                        <option value="America/Denver" {% if settings.get('timezone') == 'America/Denver' %}selected{% endif %}>Mountain Time</option>
                        <option value="America/Los_Angeles" {% if settings.get('timezone') == 'America/Los_Angeles' %}selected{% endif %}>Pacific Time</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label for="bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bio</label>
                    <textarea id="bio" name="bio" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                              placeholder="Tell me about yourself...">{{ settings.get('bio', '') }}</textarea>
                </div>
            </div>
        </div>
        
        <!-- AI Configuration -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">AI Configuration</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="ollama_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Remote Ollama Server URL</label>
                    <div class="flex space-x-2">
                        <input type="url" id="ollama_url" name="ollama_url" 
                               value="{{ settings.get('ollama_url', 'http://your-ollama-server:11434') }}"
                               class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                               placeholder="http://your-ollama-server:11434">
                        <button type="button" id="testOllamaBtn" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                            Test
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Enter the URL of your remote Ollama server</p>
                    <div id="ollamaStatus" class="mt-2 hidden">
                        <div id="ollamaSuccess" class="hidden text-sm text-green-600 dark:text-green-400"></div>
                        <div id="ollamaError" class="hidden text-sm text-red-600 dark:text-red-400"></div>
                    </div>
                </div>
                
                <div>
                    <label for="ollama_model" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">AI Model</label>
                    <div class="flex space-x-2">
                        <select id="ollama_model" name="ollama_model" 
                                class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="{{ settings.get('ollama_model', 'llama3.1:8b') }}" selected>{{ settings.get('ollama_model', 'llama3.1:8b') }}</option>
                        </select>
                        <button type="button" id="refreshOllamaModelsBtn" 
                                class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            🔄
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Select from available models on your server</p>
                </div>
                
                <div>
                    <label for="temperature" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Temperature</label>
                    <input type="range" id="temperature" name="temperature" min="0.0" max="2.0" step="0.1" 
                           value="{{ settings.get('temperature', '0.7') }}"
                           class="w-full">
                    <span id="temperature_value" class="text-sm text-gray-500">{{ settings.get('temperature', '0.7') }}</span>
                </div>
                
                <div>
                    <label for="top_p" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Top-P</label>
                    <input type="range" id="top_p" name="top_p" min="0.1" max="1.0" step="0.1" 
                           value="{{ settings.get('top_p', '0.9') }}"
                           class="w-full">
                    <span id="top_p_value" class="text-sm text-gray-500">{{ settings.get('top_p', '0.9') }}</span>
                </div>
                
                <div class="md:col-span-2">
                    <label for="personality" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">AI Personality</label>
                    <textarea id="personality" name="personality" rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                              placeholder="Describe how you want your AI companion to behave...">{{ settings.get('personality', 'You are a helpful and friendly AI companion. You are knowledgeable, empathetic, and always ready to help with conversation, advice, or just being a good friend.') }}</textarea>
                </div>
            </div>
        </div>
        
        <!-- Voice Settings -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Voice Settings</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="tts_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">TTS Server URL</label>
                    <div class="flex space-x-2">
                        <input type="url" id="tts_url" name="tts_url" 
                               value="{{ settings.get('tts_url', 'http://opentts:5500') }}"
                               class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                               placeholder="http://opentts:5500">
                        <button type="button" id="testTtsBtn" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                            Test
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Enter the URL of your TTS server</p>
                    <div id="ttsStatus" class="mt-2 hidden">
                        <div id="ttsSuccess" class="hidden text-sm text-green-600 dark:text-green-400"></div>
                        <div id="ttsError" class="hidden text-sm text-red-600 dark:text-red-400"></div>
                    </div>
                </div>
                
                <div>
                    <label for="tts_voice" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Voice</label>
                    <div class="flex space-x-2">
                        <select id="tts_voice" name="tts_voice" 
                                class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="{{ settings.get('tts_voice', 'en_US-amy-low') }}" selected>{{ settings.get('tts_voice', 'en_US-amy-low') }}</option>
                        </select>
                        <button type="button" id="refreshTtsVoicesBtn" 
                                class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                            🔄
                        </button>
                        <button type="button" id="previewVoiceBtn" 
                                class="px-3 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors">
                            🔊
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Select from available voices on your server</p>
                    <div id="voicePreviewStatus" class="mt-2 hidden">
                        <div id="voicePreviewSuccess" class="hidden text-sm text-green-600 dark:text-green-400"></div>
                        <div id="voicePreviewError" class="hidden text-sm text-red-600 dark:text-red-400"></div>
                    </div>
                    
                    <!-- Voice Preview Text Input -->
                    <div class="mt-3">
                        <label for="previewText" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Preview Text</label>
                        <div class="flex space-x-2">
                            <input type="text" id="previewText" 
                                   value="Hello, this is a voice preview. How do I sound?"
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                                   placeholder="Enter text to preview the voice">
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Customize the text used for voice preview</p>
                    </div>
                </div>
                
                <div>
                    <label for="speaking_rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Speaking Rate</label>
                    <input type="range" id="speaking_rate" name="speaking_rate" min="0.5" max="2.0" step="0.1" 
                           value="{{ settings.get('speaking_rate', '1.0') }}"
                           class="w-full">
                    <span id="speaking_rate_value" class="text-sm text-gray-500">{{ settings.get('speaking_rate', '1.0') }}</span>
                </div>
                
                <div>
                    <label for="pitch" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pitch</label>
                    <input type="range" id="pitch" name="pitch" min="0.5" max="2.0" step="0.1" 
                           value="{{ settings.get('pitch', '1.0') }}"
                           class="w-full">
                    <span id="pitch_value" class="text-sm text-gray-500">{{ settings.get('pitch', '1.0') }}</span>
                </div>
            </div>
        </div>
        
        <!-- Memory Settings -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Memory & Privacy</h2>
            
            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="checkbox" id="memory_enabled" name="memory_enabled" value="true" 
                           {% if settings.get('memory_enabled', 'true') == 'true' %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="memory_enabled" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Enable long-term memory
                    </label>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="auto_summarize" name="auto_summarize" value="true" 
                           {% if settings.get('auto_summarize', 'true') == 'true' %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="auto_summarize" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Auto-summarize conversations
                    </label>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="share_analytics" name="share_analytics" value="true" 
                           {% if settings.get('share_analytics', 'false') == 'true' %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="share_analytics" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                        Share usage analytics (anonymous)
                    </label>
                </div>
            </div>
            
            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Data Management</h3>
                
                <div class="flex space-x-4">
                    <a href="{{ url_for('privacy.export_data') }}" 
                       class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Export My Data
                    </a>
                    
                    <button type="button" id="deleteDataBtn"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Delete All Data
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="flex justify-end">
            <button type="submit" 
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                Save Settings
            </button>
        </div>
    </form>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Delete All Data?</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
                This action cannot be undone. All your conversations, memories, and settings will be permanently deleted.
            </p>
            <div class="flex space-x-4 justify-center">
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Yes, Delete Everything
                </button>
                <button id="cancelDelete" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update range input values
    const speakingRate = document.getElementById('speaking_rate');
    const speakingRateValue = document.getElementById('speaking_rate_value');
    const pitch = document.getElementById('pitch');
    const pitchValue = document.getElementById('pitch_value');
    const temperature = document.getElementById('temperature');
    const temperatureValue = document.getElementById('temperature_value');
    const topP = document.getElementById('top_p');
    const topPValue = document.getElementById('top_p_value');
    
    speakingRate.addEventListener('input', function() {
        speakingRateValue.textContent = this.value;
    });
    
    pitch.addEventListener('input', function() {
        pitchValue.textContent = this.value;
    });
    
    temperature.addEventListener('input', function() {
        temperatureValue.textContent = this.value;
    });
    
    topP.addEventListener('input', function() {
        topPValue.textContent = this.value;
    });
    
    // Delete data modal
    const deleteDataBtn = document.getElementById('deleteDataBtn');
    const deleteModal = document.getElementById('deleteModal');
    const confirmDelete = document.getElementById('confirmDelete');
    const cancelDelete = document.getElementById('cancelDelete');
    
    deleteDataBtn.addEventListener('click', function() {
        deleteModal.classList.remove('hidden');
        deleteModal.classList.add('flex');
    });
    
    cancelDelete.addEventListener('click', function() {
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
    });
    
    confirmDelete.addEventListener('click', async function() {
        try {
            const response = await fetch('/api/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                window.location.href = '/auth/login';
            } else {
                alert('Failed to delete data. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting data.');
        }
        
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
    });
    
    // Ollama connection testing and model fetching
    const testOllamaBtn = document.getElementById('testOllamaBtn');
    const refreshOllamaModelsBtn = document.getElementById('refreshOllamaModelsBtn');
    const ollamaUrlInput = document.getElementById('ollama_url');
    const ollamaModelSelect = document.getElementById('ollama_model');
    const ollamaStatus = document.getElementById('ollamaStatus');
    const ollamaSuccess = document.getElementById('ollamaSuccess');
    const ollamaError = document.getElementById('ollamaError');
    
    testOllamaBtn.addEventListener('click', async function() {
        const url = ollamaUrlInput.value.trim();
        if (!url) {
            showOllamaError('Please enter an Ollama server URL');
            return;
        }
        
        testOllamaBtn.disabled = true;
        testOllamaBtn.textContent = 'Testing...';
        
        try {
            const formData = new FormData();
            formData.append('ollama_url', url);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            const response = await fetch('{{ url_for("settings.test_ollama_connection") }}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showOllamaSuccess(data.message);
                populateOllamaModels(data.models);
            } else {
                showOllamaError(data.error);
            }
        } catch (error) {
            console.error('Error testing Ollama connection:', error);
            showOllamaError('Failed to test connection. Please check the URL and try again.');
        } finally {
            testOllamaBtn.disabled = false;
            testOllamaBtn.textContent = 'Test';
        }
    });
    
    refreshOllamaModelsBtn.addEventListener('click', async function() {
        const url = ollamaUrlInput.value.trim();
        if (!url) {
            showOllamaError('Please enter an Ollama server URL first');
            return;
        }
        
        refreshOllamaModelsBtn.disabled = true;
        refreshOllamaModelsBtn.textContent = '🔄';
        
        try {
            const formData = new FormData();
            formData.append('ollama_url', url);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            const response = await fetch('{{ url_for("settings.test_ollama_connection") }}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showOllamaSuccess(`Refreshed models from ${url}`);
                populateOllamaModels(data.models);
            } else {
                showOllamaError(data.error);
            }
        } catch (error) {
            console.error('Error refreshing Ollama models:', error);
            showOllamaError('Failed to refresh models. Please try again.');
        } finally {
            refreshOllamaModelsBtn.disabled = false;
            refreshOllamaModelsBtn.textContent = '🔄';
        }
    });
    
    function showOllamaSuccess(message) {
        ollamaStatus.classList.remove('hidden');
        ollamaSuccess.textContent = message;
        ollamaSuccess.classList.remove('hidden');
        ollamaError.classList.add('hidden');
    }
    
    function showOllamaError(message) {
        ollamaStatus.classList.remove('hidden');
        ollamaError.textContent = message;
        ollamaError.classList.remove('hidden');
        ollamaSuccess.classList.add('hidden');
    }
    
    function populateOllamaModels(models) {
        // Clear existing options except the first one
        while (ollamaModelSelect.options.length > 1) {
            ollamaModelSelect.remove(1);
        }
        
        // Add new model options
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.name;
            option.textContent = `${model.name} (${formatBytes(model.size)})`;
            ollamaModelSelect.appendChild(option);
        });
    }
    
    // TTS connection testing and voice fetching
    const testTtsBtn = document.getElementById('testTtsBtn');
    const refreshTtsVoicesBtn = document.getElementById('refreshTtsVoicesBtn');
    const ttsUrlInput = document.getElementById('tts_url');
    const ttsVoiceSelect = document.getElementById('tts_voice');
    const ttsStatus = document.getElementById('ttsStatus');
    const ttsSuccess = document.getElementById('ttsSuccess');
    const ttsError = document.getElementById('ttsError');
    
    testTtsBtn.addEventListener('click', async function() {
        const url = ttsUrlInput.value.trim();
        if (!url) {
            showTtsError('Please enter a TTS server URL');
            return;
        }
        
        testTtsBtn.disabled = true;
        testTtsBtn.textContent = 'Testing...';
        
        try {
            const formData = new FormData();
            formData.append('tts_url', url);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            const response = await fetch('{{ url_for("settings.test_tts_connection") }}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            // Debug logging
            console.log('TTS test response:', data);
            
            if (data.success) {
                showTtsSuccess(data.message);
                populateTtsVoices(data.voices);
            } else {
                showTtsError(data.error);
            }
        } catch (error) {
            console.error('Error testing TTS connection:', error);
            showTtsError('Failed to test connection. Please check the URL and try again.');
        } finally {
            testTtsBtn.disabled = false;
            testTtsBtn.textContent = 'Test';
        }
    });
    
    refreshTtsVoicesBtn.addEventListener('click', async function() {
        const url = ttsUrlInput.value.trim();
        if (!url) {
            showTtsError('Please enter a TTS server URL first');
            return;
        }
        
        refreshTtsVoicesBtn.disabled = true;
        refreshTtsVoicesBtn.textContent = '🔄';
        
        try {
            const formData = new FormData();
            formData.append('tts_url', url);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            const response = await fetch('{{ url_for("settings.test_tts_connection") }}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            // Debug logging
            console.log('TTS refresh response:', data);
            
            if (data.success) {
                showTtsSuccess(`Refreshed voices from ${url}`);
                populateTtsVoices(data.voices);
            } else {
                showTtsError(data.error);
            }
        } catch (error) {
            console.error('Error refreshing TTS voices:', error);
            showTtsError('Failed to refresh voices. Please try again.');
        } finally {
            refreshTtsVoicesBtn.disabled = false;
            refreshTtsVoicesBtn.textContent = '🔄';
        }
    });
    
    // Voice Preview Button
    const previewVoiceBtn = document.getElementById('previewVoiceBtn');
    const previewTextInput = document.getElementById('previewText');
    const voicePreviewStatus = document.getElementById('voicePreviewStatus');
    const voicePreviewSuccess = document.getElementById('voicePreviewSuccess');
    const voicePreviewError = document.getElementById('voicePreviewError');
    
    previewVoiceBtn.addEventListener('click', async function() {
        const selectedVoice = ttsVoiceSelect.value;
        const previewText = previewTextInput.value.trim();
        
        if (!selectedVoice) {
            showVoicePreviewError('Please select a voice first');
            return;
        }
        
        if (!previewText) {
            showVoicePreviewError('Please enter preview text');
            return;
        }
        
        previewVoiceBtn.disabled = true;
        previewVoiceBtn.textContent = '⏳';
        
        try {
            const formData = new FormData();
            formData.append('voice_id', selectedVoice);
            formData.append('preview_text', previewText);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            const response = await fetch('{{ url_for("settings.preview_voice") }}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showVoicePreviewSuccess('Voice preview generated successfully!');
                // Play the audio preview
                playAudioPreview(data.audio_data);
            } else {
                showVoicePreviewError(data.error);
            }
        } catch (error) {
            console.error('Error generating voice preview:', error);
            showVoicePreviewError('Failed to generate preview. Please try again.');
        } finally {
            previewVoiceBtn.disabled = false;
            previewVoiceBtn.textContent = '🔊';
        }
    });
    
    function playAudioPreview(audioData) {
        try {
            // Convert base64 to audio blob
            const byteCharacters = atob(audioData);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'audio/wav' });
            
            // Create audio element and play
            const audio = new Audio(URL.createObjectURL(blob));
            audio.play().catch(e => {
                console.error('Error playing audio:', e);
                showVoicePreviewError('Audio preview generated but could not play automatically');
            });
        } catch (error) {
            console.error('Error processing audio preview:', error);
            showVoicePreviewError('Error processing audio preview');
        }
    }
    
    function showVoicePreviewSuccess(message) {
        voicePreviewStatus.classList.remove('hidden');
        voicePreviewSuccess.textContent = message;
        voicePreviewSuccess.classList.remove('hidden');
        voicePreviewError.classList.add('hidden');
    }
    
    function showVoicePreviewError(message) {
        voicePreviewStatus.classList.remove('hidden');
        voicePreviewError.textContent = message;
        voicePreviewError.classList.add('hidden');
        voicePreviewSuccess.classList.remove('hidden');
    }
    
    function showTtsSuccess(message) {
        ttsStatus.classList.remove('hidden');
        ttsSuccess.textContent = message;
        ttsSuccess.classList.remove('hidden');
        ttsError.classList.add('hidden');
    }
    
    function showTtsError(message) {
        ttsStatus.classList.remove('hidden');
        ttsError.textContent = message;
        ttsError.classList.remove('hidden');
        ttsSuccess.classList.add('hidden');
    }
    
    function populateTtsVoices(voices) {
        // Clear existing options except the first one
        while (ttsVoiceSelect.options.length > 1) {
            ttsVoiceSelect.remove(1);
        }
        
        // Add new voice options
        voices.forEach(voice => {
            const option = document.createElement('option');
            // Use voice.id as the value, fallback to voice.name if id is not available
            option.value = voice.id || voice.name;
            const description = voice.description || voice.name;
            option.textContent = `${voice.name} (${voice.language || 'Unknown'})`;
            ttsVoiceSelect.appendChild(option);
        });
        
        // Log for debugging
        console.log('Populated TTS voices:', voices);
        console.log('Voice select options:', Array.from(ttsVoiceSelect.options).map(opt => ({value: opt.value, text: opt.textContent})));
    }
    
    // Utility function to format bytes
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
});
</script>
{% endblock %}
